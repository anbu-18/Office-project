import sqlite3
from flask import jsonify
import json
import config


class malwaredetect():

####################### DB Connection ########################################
    def __init__(self):
        try:
            self.conn =  sqlite3.connect(config.dbpath)
            self.c = self.conn.cursor()
        except Exception as e:
            print ("Error while connecting DB",e)
            return "Error while connecting DB"
              
####################### Table Creation #######################################
    def table_creation(self):
        try:
            self.c.execute('CREATE TABLE IF NOT EXISTS urlcollection(urls TEXT)')
        except Exception as e:
            print("Error while creating table: ",e)
            return "Error while creating table"

####################### insert data into database ############################
    def table_values(self,urldata):
        try:
            url = urldata['url']
            self.c.execute("INSERT INTO urlcollection VALUES ('"+url+"')")
            self.conn.commit()
            return "inserted successfully"
        except Exception as e:
            print("Error while enter the values into the DB: ",e)
            return "Error while enter the values into the DB"
        finally:
            self.c.close()
            self.conn.close()
    
######################### fetching all values from a DB ######################
    
    def getallvalues(self):
        try:
            self.c.execute("SELECT * from urlcollection")
            val = self.c.fetchall()
            json_value = json.dumps(val)
            return json_value
        except Exception as e:
            print ("Error while fetching data: ",e)
            return "Error while fetching data"
        finally:
            self.c.close()
            self.conn.close()
            


########################## To check whether URL is available in DB , if yes return block else allow ############
    def detection(self,urldata):
        try:
            url = urldata['url']
            self.c.execute("SELECT COUNT(*) from urlcollection where urls = '"+url+"'")
            count = self.c.fetchone()
            if count[0] == 0:
                response = jsonify({"status":"Allow"})
                return response
            else:
                response = jsonify({"status":"Blocked"})
                return response
        except Exception as e :
            print("Error while finding URL in DB: ",e)
            return "Error while finding URL in DB"
        finally:
            self.c.close()
            self.conn.close()
            
############################ Clear the database ###############################
    def deleteall(self):
        try:
            self.c.execute("Delete from urlcollection")
            self.conn.commit()
            return "Deleted Successfully"
        except Exception as e :
            return "Error while clearing values"
        finally:
            self.c.close()
            self.conn.close()
        
        
